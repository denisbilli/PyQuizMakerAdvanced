{% extends 'base.html' %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col">
            <h1 class="mb-3 text-primary">{{ exercise.title }}</h1>
            <h5 class="mb-3 text-muted">Tipologia: {{ exercise.get_type_display }}</h5>
            {% if exercise.test.is_graded %}
                <h3 class="mb-3 text-success">Punti: {{ exercise.score }}</h3>
            {% endif %}
        </div>
    </div>
    <div class="row mt-4">
        <div class="col-md-6">
            <h5 class="mb-3 text-info">Descrizione:</h5>
            <div class="text-justify">{{ exercise.description|safe }}</div>
        </div>
        <div class="col-md-6">
            <h5>Risposta:</h5>
            <form action="{% url 'submit_exercise' exercise.id %}" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                {% if exercise.type == 'O' %}
                    <div class="form-group">
                      <textarea class="form-control" name="answer_text" rows="5">{% if submission %}{{ submission.answer_text }}{% elif not exercise.test.is_graded %}{{ exercise.expected_answer }}{% endif %}</textarea>
                    </div>
                {% elif exercise.type == 'M' %}
                    {% for choice in exercise.choices.all %}
                      <div class="form-check {% if choice.is_correct %}correct{% endif %}">
                        <input class="form-check-input" type="radio" name="answer_choice" id="choice{{ forloop.counter }}" value="{{ choice.id }}" {% if submission and submission.answer_choice.id == choice.id %}checked{% endif %}>
                        <label class="form-check-label" for="choice{{ forloop.counter }}">
                          {{ choice.text }}
                        </label>
                      </div>
                    {% endfor %}
                {% elif exercise.type == 'C' %}
<pre>
<code class="language-cpp" id="answer">#include &#60;iostream&#62;

int main() {
    // Scrivi qui il tuo esercizio
    return 0;
}</code>
</pre>
                {% if exercise.test.is_graded %}
                    <button type="button" onclick="pasteCode()" class="btn btn-primary">Incolla il tuo codice</button>
                {% endif %}
                <input type="hidden" name="answer_text" id="answer_text" value="{% if submission %}{{ submission.answer_text }}{% elif not exercise.test.is_graded %}{{ exercise.expected_answer }}{% endif %}">
                {% elif exercise.type == 'D' %}
                    <div class="form-group">
                      <textarea class="form-control" name="answer_text" id="open_answer" rows="5" style="display: none">{% if submission %}{{ submission.answer_text }}{% elif not exercise.test.is_graded %}{{ exercise.expected_answer }}{% endif %}</textarea>
                    </div>
                {% endif %}
                <div class="fixed-bottom d-flex justify-content-between p-3 bg-light">
                    {% if not exercise.test.is_graded %}
                        <button type="button" onclick="showSolution()" class="btn btn-info" id="btnShowSolution">Mostra soluzione</button>
                        {% if not user_exercise.signed %}
                            <button type="submit" class="btn btn-success" id="btnSignExercise">Contrassegna</button>
                        {% else %}
                            <button type="submit" class="btn btn-danger" id="btnSignExercise">Rimuovi contrassegno</button>
                        {% endif %}
                    {% else %}
                        <button type="submit" class="btn btn-primary" id="btnSendAnswer">Invia Risposta</button>
                    {% endif %}
                    <button type="button" onclick="location.href='{% url 'exercise_list' exercise.test.id %}'" class="btn btn-secondary">Indietro</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}


{% block custom_css %}
<style>
input[type="radio"] {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    display: inline-block;
    width: 20px;
    height: 20px;
    padding: 3px;
    background-clip: content-box;
    border: 2px solid #bbbbbb;
    background-color: #e7e6e7;
    border-radius: 50%;
}

.form-check-label {
    margin-left: 20px;
    line-height: 2.5em;  /* Adjust this value as per your requirement */
}

input[type="radio"]:checked {
    background-color: #4a90e2;
}

div.form-check {
    display: flex;
    align-items: center;
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/9.0.0/mermaid.min.js"></script>
<script>
    var is_graded = "{{ exercise.test.is_graded|escapejs }}" == 'False' ? false : true;

    function highlightCode() {
        Prism.highlightAll();
    }

    function pasteCode() {
        const codeElement = document.querySelector('#answer');
        const hiddenInput = document.querySelector('#answer_text');

        navigator.clipboard.readText().then((text) => {
            hiddenInput.value = text;

            html_text = Prism.highlight(text, Prism.languages.cpp, 'cpp');
            codeElement.innerHTML = html_text;
        });
    }

    function showSolution() {
        const codeElement = document.querySelector('#answer');
        const hiddenInput = document.querySelector('#answer_text');
        const openAnswer = $('#open_answer');

        const wrongChoices = $('.form-check');
        wrongChoices.css('color', 'red');

        const correctChoice = $('.form-check.correct');
        correctChoice.css('color', 'green');

        if(hiddenInput != null) {
            html_text = Prism.highlight(hiddenInput.value, Prism.languages.cpp, 'cpp');
            codeElement.innerHTML = html_text;
        }

        if(openAnswer != null) {
            openAnswer.fadeIn();
        }
    }

    $(document).ready(function() {
        const codeElement = document.querySelector('#answer');
        const hiddenInput = document.querySelector('#answer_text');
        const openAnswer = $('#open_answer');

        if(hiddenInput != null && hiddenInput.value != "" && is_graded) {
            html_text = Prism.highlight(hiddenInput.value, Prism.languages.cpp, 'cpp');
            codeElement.innerHTML = html_text;
        } else {
            highlightCode();
        }

        if(openAnswer != null) {
            openAnswer.hide();
        }

        // diagrammi di flusso
        mermaid.initialize({
            startOnLoad: true,
            theme: 'normal'
        });
    });
</script>
{% endblock %}